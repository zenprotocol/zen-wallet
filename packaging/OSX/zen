#!/bin/sh
#
# This is a stub script that allows .apps to be relocatable on OSX but still
# find the managed assembly.
#
# You should never have to edit this file directly as its generated by the
# bundle maker.
#

#TODO: mind my own changes to this generated file? (SWITCHES, OUTPUT)

X11_MODE=0
MWF_MODE=1
COCOASHARP_MODE=0

PWD=`pwd`
# Fetch the path relative to the launch point where this shell script exists.
APP_PATH=`echo $0 | awk '{split($0,patharr,"/"); idx=1; while(patharr[idx+3] != "") { if (patharr[idx] != "/") {printf("%s/", patharr[idx]); idx++ }} }'`
SWITCHES="--arch=32"
OUTPUT="output.txt"
# Fetch the app name (its our own name)
APP_NAME=zen
ASSEMBLY=zen.exe

# Setup the environment for MWF if needed
if [ "$MWF_MODE" -eq "1" ]; then
	export MONO_MWF_USE_CARBON_BACKEND=1
	export LANG=en_US.UTF-8
	export GDIPLUS_NOX=1
fi

cd "$APP_PATH/Contents/Resources"

if [ "$X11_MODE" -eq "1" ]; then
	open-x11 "$APP_NAME"

# rcruzs00
# El Capitan FIX: `which` wont work (system-integrity-protection)
# elif: Keep compatibility with previous code
elif [ -f /usr/local/bin/mono ]; then
        DIR=$(cd "$(dirname "$0")"; pwd)
        /usr/local/bin/mono $SWITCHES $DIR/../Resources/"$ASSEMBLY" > $OUTPUT

# Mono 5 fix
elif [ -f /Library/Frameworks/Mono.framework/Versions/Current/Commands/mono ]; then
        DIR=$(cd "$(dirname "$0")"; pwd)
        /Library/Frameworks/Mono.framework/Versions/Current/Commands/mono $SWITCHES $DIR/../Resources/"$ASSEMBLY" > $OUTPUT

else
	if [ ! -d "./bin" ]; then mkdir bin ; fi
	if [ -f "./bin/$APP_NAME" ]; then rm -f "./bin/$APP_NAME" ; fi
	ln -s `which mono` "./bin/$APP_NAME"
	"./bin/$APP_NAME" $SWITCHES "$ASSEMBLY" > $OUTPUT
fi
